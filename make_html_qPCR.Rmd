---
title: "WW-5/12-5/19_Baylor-Spike-in"
author: "Prashant Kalvapalle"
date: "1 June 2020"
output: 
  html_document:
    theme: flatly
    toc: TRUE
    toc_float: TRUE
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = F, message = F, warning = F, fig.width = 12, fig.height = 4)
```

## Goal of the analysis

We want to test the efficiency of viral RNA recovery from wastewater by spiking in known ammounts of bovine viruses and quantifying by qPCR. 

## All data

### Pilot run 

 Grey points = Technical replicates of RT-qPCR
```{r pilot}
source('general_functions.R')

flnm <- 'WW1_Baylor-bovine_test'  # set the filename
flpath <- str_c('excel files/',flnm,'.xls') # this completes the file path
plate_template_raw <- read_sheet('https://docs.google.com/spreadsheets/d/19oRiRcRVS23W3HqRKjhMutJKC2lFOpNK8aNUkC-No-s/edit#gid=478762118', sheet = 'Plate layouts', range = 'B36:N44')

source('analysis.R') ; res1 <- results_abs_preserved # run pilot samples and capture formatted results
```

### Larger run 

```{r large_run}

flnm <- 'WW2_Baylor-bovine'  # set the filename
flpath <- str_c('excel files/',flnm,'.xls') # this completes the file path
plate_template_raw <- read_sheet('https://docs.google.com/spreadsheets/d/19oRiRcRVS23W3HqRKjhMutJKC2lFOpNK8aNUkC-No-s/edit#gid=478762118', sheet = 'Plate layouts', range = 'B47:N55')

source('analysis.R') ; res2 <- results_abs_preserved # run pilot samples and capture formatted results

compiled_results <- bind_rows(res1, res2) %>% rename('Tube ID' = assay_variable, Cq = CT) %>% separate(`Tube ID`, c('unique_tube', 'biological_replicate'), remove = F) %>% mutate(unique_tube = as.numeric(unique_tube)) %>% arrange(`Sample Name`, unique_tube, biological_replicate) %>% select(`Sample Name`, Target, `Tube ID`, Cq, `Copy #`, everything()) # combine the data from WW1 and WW2; order by sample name and tube ID

# bring the sample names list(s)
tube_lookup <- read_sheet('https://docs.google.com/spreadsheets/d/1mJcCt1wMiOuBic6sRlBZJf8KSNu2y-B5PjzCUu7jPM8/edit#gid=1935582781', sheet = 'RNA extracts', range = 'A1:D83') %>% rename('Tube ID' = `Label on tube`, 'Biobot_ID' = 2, 'Sample Name' = 4) %>% mutate(Metadata = as.character(Metadata), `Tube ID` = as.character(`Tube ID`)) %>% fill(`Sample Name`)

biobot_lookup <- map_df(c('Week 5 (5/11)', 'Week 6 (5/18)') , ~ read_sheet('https://docs.google.com/spreadsheets/d/1ghb_GjTS4yMFbzb65NskAlm-2Gb5M4SNYi4FHE4YVyI/edit#gid=233791008', sheet = .x, range = 'D:F')) %>% rename('Biobot_ID' = `BioBot ID#`) %>% mutate(Biobot_ID = str_remove(Biobot_ID,'\\.'))

labelled_results <- left_join(compiled_results, tube_lookup) %>% left_join(biobot_lookup)

write_sheet(labelled_results,'https://docs.google.com/spreadsheets/d/1ouk-kCJHERRhOMNP07lXfiC3aGB4wtWXpnYf5-b2CI4/edit#gid=0', sheet = 'Baylor 5/12; 5/19') # save results to a google sheet
```

### Complete data

 Grey points = Biological replicates of wastewater from the same WWTP 
 
```{r calculations}
proc_data <- read_sheet('https://docs.google.com/spreadsheets/d/19oRiRcRVS23W3HqRKjhMutJKC2lFOpNK8aNUkC-No-s/edit#gid=1386677460', sheet = 'RT-qPCR results', range = 'C2:R119') 
proc_data %<>% separate(`Tube ID`, into = c('Tube ID', 'Biological_replicate')) %>% mutate(`Sample Name` = str_replace(`Sample Name`, 'WW', 'HA')) %>% arrange(Target, `Sample Name`) # merge biological replicates
proc_summary <- proc_data  %>% group_by(Target, `Sample Name`, `Tube ID`) %>% summarise_at(vars(2:6), funs(mean(.,na.rm = T), sd)) # Summarize mean and SD for biological replicates

tube_order <- proc_summary %>% filter(`Sample Name` == '5/12') %>% arrange(`Copy #_mean`) %>% pull(`Tube ID`) # order samples by 5/12 ascending order
proc_summary$`Tube ID` %<>%  fct_relevel(levels = tube_order) # order samples by 5/12 ascending order

concise_summary <- proc_summary %>% gather(key = 'Measurement', value = 'Reading', -Target, -`Sample Name`, -`Tube ID`) %>% separate(Measurement, into = c('Measurement','val'),"_") %>% spread(val,Reading) # Seperate mean and variance and group by variable of measurement


plt1 <- proc_summary %>% ggplot(aes(x = `Tube ID`, y = `Copy #_mean`, colour = Target)) +
  geom_point(size = 2) + geom_errorbar(aes(ymin = `Copy #_mean` - `Copy #_sd`, ymax = `Copy #_mean` + `Copy #_sd`, width = errorbar_width)) +
  geom_jitter(data = proc_data, aes(x = `Tube ID`, y = `Copy #`), size = 1, colour = 'black', alpha = .2, width = .2 ) + 
  facet_grid(~`Sample Name`, scales = 'free_x', space = 'free_x') +
  ggtitle('Baylor-Spike-in vaccine quantification') + ylab('Genome copies/ul RNA')

plt1 %>% format_classic() %>% format_logscale() %>% print()
```


### Expected vs Recovered

Small circles are individual data points, coloured large circles show average of biological replicates

* open black circles = copies of virus spiked in (estimate)
* grey circles = calculated genome copies recovered (per litre wastewater) 

```{r comparision_plot}
plt2 <- proc_summary %>% ggplot(aes(x = `Tube ID`, y = `Recovered_mean`, colour = Target)) +
  geom_point(size = 2) + geom_errorbar(aes(ymin = `Recovered_mean` - `Recovered_sd`, ymax = `Recovered_mean` + `Recovered_sd`, width = errorbar_width)) +
  geom_jitter(data = proc_data, aes(x = `Tube ID`, y = Recovered), size = 1, colour = 'black', alpha = .2, width = .2 ) + 
  geom_point(data = proc_data, aes(x = `Tube ID`, y = `Actual spike-in`), size = 1, shape = 21, colour = 'black') +
  facet_grid(~`Sample Name`, scales = 'free_x', space = 'free_x') +
  ggtitle('Baylor-Spike-in vaccine quantification') + ylab('Genome copies/l WW')

plt2 %>% format_classic() %>% format_logscale() %>% print()

```

### Recovery fractions

* 5/12 (CF) => Centricon filtration method
* 5/12 and 5/19 => PEG filtration method
* Vac, Water and HA => HA filtration (stadler lab)

```{r fraction}

plt3 <- concise_summary %>% filter(Measurement == 'Recovery fraction') %>% ggplot(aes(x = `Tube ID`, y = mean, colour = Target)) +
  geom_point(size = 2) + geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd, width = errorbar_width)) +
  geom_jitter(data = proc_data, aes(x = `Tube ID`, y = `Recovery fraction`), size = 1, colour = 'black', alpha = .2, width = .2 ) +
  facet_grid(~`Sample Name`, scales = 'free_x', space = 'free_x') +
  ggtitle('Baylor-Spike-in vaccine quantification') + ylab('Recovery %')

plt3 %>% format_classic() %>% print()

```

## Concise plots

### Expected vs Recovered: Selected

Small circles are individual data points, coloured large circles show average of biological replicates

* open black circles = copies of virus spiked in (estimate)
* grey circles = calculated genome copies recovered (per litre wastewater) 

```{r comparision_plot2}
proc_data_sel <- filter(proc_data, str_detect(`Sample Name`,'5/|HA')) # filter the data to be plotted

plt2s <- proc_summary %>% filter(str_detect(`Sample Name`,'5/|HA')) %>% ggplot(aes(x = `Tube ID`, y = `Recovered_mean`, colour = Target)) +
  geom_point(size = 2) + geom_errorbar(aes(ymin = `Recovered_mean` - `Recovered_sd`, ymax = `Recovered_mean` + `Recovered_sd`, width = errorbar_width)) +
  geom_jitter(data = proc_data_sel, aes(x = `Tube ID`, y = Recovered), size = 1, colour = 'black', alpha = .2, width = .2 ) + 
  geom_point(data = proc_data_sel, aes(x = `Tube ID`, y = `Actual spike-in`), size = 1, shape = 21, colour = 'black') +
  facet_grid(~`Sample Name`, scales = 'free_x', space = 'free_x') +
  ggtitle('Baylor-Spike-in vaccine quantification') + ylab('Genome copies/l WW')

plt2s %>% format_classic() %>% format_logscale() %>% print()
```

### Recovery fractions: Selected

* 5/12 (CF) => Centricon filtration method
* 5/12 and 5/19 => PEG filtration method
* HA => HA filtration (stadler lab)

```{r fraction2}

plt3s <- concise_summary %>% filter(Measurement == 'Recovery fraction', str_detect(`Sample Name`,'5/|HA')) %>% ggplot(aes(x = `Tube ID`, y = mean, colour = Target)) +
  geom_point(size = 2) + geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd, width = errorbar_width)) +
  geom_jitter(data = proc_data_sel, aes(x = `Tube ID`, y = `Recovery fraction`), size = 1, colour = 'black', alpha = .2, width = .2 ) +
  facet_grid(~`Sample Name`, scales = 'free_x', space = 'free_x') +
  ggtitle('Baylor-Spike-in vaccine quantification') + ylab('Recovery %')

plt3s %>% format_classic() %>% print()

```

### PEG vs centricon filters

* 5/12 (CF) => Centricon filtration 
* 5/12 and 5/19 => PEG filtration

```{r PEG,CF}

plt4 <- concise_summary %>% filter(Measurement == 'Recovery fraction', str_detect(`Sample Name`, '5/12')) %>% ggplot(aes(x = `Tube ID`, y = mean, colour = Target)) +
  geom_point(size = 2) + geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd, width = errorbar_width)) +
  facet_grid(~`Sample Name`, scales = 'free_x', space = 'free_x') +
  ggtitle('Baylor-Spike-in vaccine quantification') + ylab('Recovery %')

plt4 %>% format_classic() %>% print()
```


### 5/12 vs 5/19

* 5/12 (CF) => Centricon filtration 
* 5/12 and 5/19 => PEG filtration

```{r 12,19}

plt5 <- concise_summary %>% filter(Measurement == 'Recovery fraction', str_detect(`Sample Name`, '5/1.$')) %>% ggplot(aes(x = `Tube ID`, y = mean, colour = Target)) +
  geom_point(size = 2) + geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd, width = errorbar_width)) +
  geom_jitter(data = filter(proc_data,  str_detect(`Sample Name`, '5/1.$')), aes(x = `Tube ID`, y = `Recovery fraction`), size = 1, colour = 'black', alpha = .2, width = .2 ) +
  facet_grid(~`Sample Name`, scales = 'free_x', space = 'free_x') +
  ggtitle('Baylor-Spike-in vaccine quantification') + ylab('Recovery %')

plt5 %>% format_classic() %>% print()
```

### 5/19

5/12 and 5/19 => PEG filtration

```{r 5/19}

plt6 <- concise_summary %>% filter(Measurement == 'Recovery fraction', str_detect(`Sample Name`, '5/19')) %>% ggplot(aes(x = `Tube ID`, y = mean, colour = Target)) +
  geom_point(size = 2) + geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd, width = errorbar_width)) +
  geom_jitter(data = filter(proc_data,  str_detect(`Sample Name`, '5/19')), aes(x = `Tube ID`, y = `Recovery fraction`), size = 1, colour = 'black', alpha = .2, width = .2 ) +
  facet_grid(~`Sample Name`, scales = 'free_x', space = 'free_x') +
  ggtitle('Baylor-Spike-in vaccine quantification') + ylab('Recovery %')

plt6 %>% format_classic() %>% print()
```

## Interactive: Recovery fraction

* 5/12 (CF) => Centricon filtration method
* 5/12 and 5/19 => PEG filtration method
* Vac, Water and HA => HA filtration (stadler lab)

```{r interactive}
plt3 %>% format_classic() %>% ggplotly()

# iplt3 <- plt3 <- concise_summary %>% filter(Measurement == 'Recovery fraction') %>%
#  plot_ly(x = ~`Tube ID`, y = ~mean, color = ~Target, type = 'scatter', mode = 'markers') + facet_grid()
```

### % variability

```{r biological_variability}

plt7 <- concise_summary %>% mutate(variation = (sd/mean)* 100) %>% filter(`Sample Name` == '5/19', Measurement == 'Recovered') %>% ggplot(aes(x = `Tube ID`, y = variation)) +
  geom_point(size = 2) +
  facet_grid(~`Sample Name`, scales = 'free_x', space = 'free_x') +
  ggtitle('Baylor-Spike-in vaccine quantification', subtitle = 'High variability among biological replicates') + ylab('% variability (sd/mean) Recovered copies/l ww')

plt7 %>% format_classic() %>% print()
```
